<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{margin:0;background:#000}b{display:flex;justify-content:center;align-items:center}canvas{height:100vmin;width:100vmin}</style><b><canvas></canvas></b><script>function e(e,t){let a=1e4*b(g++);return f((a-f(a))*(t-e)+e)}function t(t){return t.splice(e(0,t.length),1)[0]}function a(e,t,a=1,o=0){let r=v(o),i=b(o);return new Float32Array([r*a,i*a,0,0,-i*a,r*a,0,0,0,0,1,0,e,t,0,1])}function o(e){let[t,a]=e,o=c(t*t+a*a);return[t/o,a/o]}function r(e,t){document.title=`Current: ${e}, Max: ${t}`}function n(e,t,a){let o=e.createShader(t?e.FRAGMENT_SHADER:e.VERTEX_SHADER);return e.shaderSource(o,a),e.compileShader(o),o}function i(e,a,o){return e+o*(a-e)}function s(e){return m(4*Math.log2(e+1)+2)}function l(e,t){return e*p(2,(t-49)/12)}function d(){let e=G.gl;e.clear(e.COLOR_BUFFER_BIT),z.draw(),u.requestAnimationFrame(d)}var p=Math.pow,c=Math.sqrt,v=Math.cos,b=Math.sin,m=Math.floor;let u=window,f=m,h={lastFrame:Date.now(),delta:0};let g=m(1e4*Math.random());var S={INITIAL_PLAYER_SPEED:1.2,TRANSITION:350,RENDER_AOE:4,MAX_TOUCH_DISTANCE:150,TIME_DILATION:1,CAMERA_SCALE:12,MINIMAP_DURATION:15000,SHIELD_DURATION:1e4};class A{constructor(e=0,t=0){this.x=e,this.y=t}clone(){return new A(this.x,this.y)}subtract(e){return e instanceof A?new A(this.x-e.x,this.y-e.y):new A(this.x-e,this.y-e)}add(e){return e instanceof A?new A(this.x+e.x,this.y+e.y):new A(this.x+e,this.y+e)}multiply(e){return e instanceof A?new A(this.x*e.x,this.y*e.y):new A(this.x*e,this.y*e)}dist2(e){let t=e?this.subtract(e):this;return t.x*t.x+t.y*t.y}dist(e){return c(this.dist2(e))}normalize(){let e=this.dist();return new A(this.x/e,this.y/e)}}class y{constructor(e,t){this.untouched=[],this.children=[],this.touched=!1,this.distance=0,this.time=0,this.position=new A(e,t)}passable(e,t=0){if(e=e.clone(),0.5>e.x?e.x-=t:e.x+=t,0.5>e.y?e.y-=t:e.y+=t,e.x=m(e.x),e.y=m(e.y),this.position.x===e.x&&this.position.y===e.y)return!0;for(let a of this.children)if(a.position.x===m(e.x)&&a.position.y===m(e.y))return!0;return!1}draw(e){let{x:o,y:r}=this.position,i=e.renderer,n=i.gl;i.modelMat=a(o,r),i.setMatrices();let s=m(e.player.position.x)===o&&m(e.player.position.y)===r;n.uniform1i(e.mazeShaders.playerSpace,s?1:0),n.uniform1i(e.mazeShaders.squareState,this===e.start?0:this===e.end?1:this.touched?2:3);let l=this.time?(Date.now()-this.time)/S.TRANSITION:0;1<l&&(l=1),n.uniform1f(e.mazeShaders.t,l);let t=Date.now()/1e3%1;n.uniform1f(e.mazeShaders.pulse,t),n.drawArrays(n.TRIANGLE_STRIP,0,4)}}class x{constructor(e,t){this.width=e,this.height=t,this.nodes={}}get(e){e=e.clone(),e.x=m(e.x),e.y=m(e.y);let t=[e.x,e.y].toString();if(e.x>=this.width||e.y>=this.height||0>e.x||0>e.y)return null;let a=this.nodes[t];return a||(a=this.nodes[t]=new y(e.x,e.y)),a}draw(e,t){e.mazeShaders.use();let a=e.renderer,o=a.gl;for(let r in o.bindBuffer(o.ARRAY_BUFFER,a.squareBuffer),o.vertexAttribPointer(e.mazeShaders.vertPos,2,o.FLOAT,!1,0,0),o.uniform1i(e.mazeShaders.isMinimap,t?1:0),this.nodes){let t=this.nodes[r];t.draw(e)}}}let T=[new A(-1,0),new A(1,0),new A(0,-1),new A(0,1)];var I=function(a,o){let r=new x(a,o);for(let e=0;e<a;e++)for(let t=0;t<o;t++){let a=new A(e,t),o=r.get(a);for(let e of T){let t=r.get(a.add(e));t&&o.untouched.push(t)}}let i=r.get(new A(e(0,a),e(0,o))),n=[i];let s=i;for(;n.length;){let e=n[0];if(e.touched=!0,!e.untouched.length){n.shift();continue}let a=t(e.untouched);a.touched||(a.untouched.splice(a.untouched.indexOf(e),1),a.children.push(e),a.distance=e.distance+1,a.distance>s.distance&&(s=a),e.children.push(a),a.touched=!0,n.splice(0,0,a))}return[r,i,s]};let w="precision mediump float;attribute vec2 n;uniform mat4 q,s,t;varying vec2 d;void main(){gl_Position=t*s*q*vec4(n,0,1),d=n;}",E={fade:"f",modelMat:"q",viewMat:"s",projMat:"t",hp:"g",t:"j",squareState:"k",isMinimap:"m",playerSpace:"o",pulse:"l"},R={vertPos:"n"};let _;class P{constructor(e,...t){this.renderer=e;let a=this.shaderProgram=_.createProgram();for(let o=0;2>o;o+=1)_.attachShader(a,n(_,o,t[o]));for(let o in _.linkProgram(a),this.use(),E)this[o]=_.getUniformLocation(a,E[o]);for(let o in R)this[o]=_.getAttribLocation(a,R[o]),_.enableVertexAttribArray(this[o])}use(){this.renderer.use(this)}}class M{constructor(e,t){this.bulletScale=0.05,this.bulletSpeed=0.6,this.position=new A(e,t)}draw(e){let t=e.renderer,o=t.gl;e.bulletShaders.use(),t.modelMat=a(this.position.x-this.bulletScale/2,this.position.y-this.bulletScale/2,this.bulletScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let t=this.position.add(this.vector.multiply(this.bulletSpeed*h.delta)),a=e.grid.get(this.position),o=e.grid.get(t),r=e.player;if(o&&o!==e.start&&o!==e.end&&a.passable(t,this.bulletScale/2)){let{x:o,y:i}=r.position;return a.passable(r.position)&&e.grid.get(r.position)!==e.start&&t.dist(r.position)<(r.playerScale+this.bulletScale)/2?(r.attack(0.06),!1):(this.position=t,!0)}return!1}}class L{constructor(e,t,a,o){this.level=a,this.distance=o,this.position=new A(e,t)}}class N{constructor(e,t){this.position=new A(e,t)}}class D extends N{constructor(e,t){super(e+0.5,t+0.5),this.shieldScale=0.5,this.fade=0}draw(e){let t=e.renderer,o=t.gl;e.shieldProgram.use(),o.uniform1f(e.shieldProgram.fade,this.fade),t.modelMat=a(this.position.x-this.shieldScale/2,this.position.y-this.shieldScale/2,this.shieldScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let{player:t}=e;if(!this.grabbed)0.05>t.position.dist2(this.position)&&(this.grabbed=Date.now(),e.player.shield=Date.now());else if(this.fade=(Date.now()-this.grabbed)*S.TIME_DILATION/300,1<this.fade)return!1;return!0}}class F extends N{constructor(e,t){super(e+0.5,t+0.5),this.fade=0}draw(e){var t=Math.PI;let o=1/e.grid.height,r=e.renderer,i=r.gl,n=Date.now(),l=v(2*(n/1e3%t)),d=b(2*(n/1e3%t)),s=e.renderer.camera,p=S.CAMERA_SCALE,c=l*o,m=d*o,u=this.position.subtract(e.player.position);r.camera=new Float32Array([c,m,0,0,-m,c,0,0,0,0,1,0,p*(u.x-0.1*(c+m)),p*(u.y-0.2*(c-m)),1,1]),e.dropShadowShaders.use(),i.uniform1f(e.dropShadowShaders.fade,this.fade),r.modelMat=a(-0.1/o,-0.1/o,1.2*e.grid.height),r.setMatrices(),i.drawArrays(i.TRIANGLE_STRIP,0,4),e.mazeShaders.use(),i.uniform1f(e.mazeShaders.fade,this.fade),e.grid.draw(e,!0),i.uniform1f(e.mazeShaders.fade,0),e.renderer.camera=s}simulate(e){let{player:t}=e;if(!this.grabbed)0.05>t.position.dist2(this.position)&&(this.grabbed=Date.now(),e.minimapActivated=Date.now());else if(this.fade=(Date.now()-this.grabbed)*S.TIME_DILATION/300,1<this.fade)return!1;return!0}}class C extends L{constructor(e,t,a,o){super(e,t,a,o),this.maxEnemyScale=0.2,this.maxExplosionScale=0.7,this.explosionScale=0,this.currentSpeed=0,this.chaseTime=2500,this.accelTime=600,this.explodeTime=500,this.spent=!1,this.enemyScale=this.maxEnemyScale,this.maxSpeed=0.8*S.INITIAL_PLAYER_SPEED}draw(e){let t=e.renderer,o=t.gl;e.proximityProgram.use(),t.modelMat=a(this.position.x-this.enemyScale/2,this.position.y-this.enemyScale/2,this.enemyScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4),e.explosionProgram.use(),t.modelMat=a(this.position.x-this.explosionScale/2,this.position.y-this.explosionScale/2,this.explosionScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let t=e.grid.get(this.position),a=e.player,{x:o,y:r}=a.position,n=a.position.subtract(this.position),s=n.normalize(),l=n.dist2(),d=t.passable(a.position);if(!this.startTime&&0.5>l&&d)this.startTime=Date.now();else if(this.startTime){let t=(Date.now()-this.startTime)*S.TIME_DILATION;if(t<this.chaseTime){if(1e-3<l&&d){let e=(Date.now()-this.startTime)/this.accelTime,t=i(0,this.maxSpeed,1<e?1:e);this.position=this.position.add(s.multiply(t*h.delta))}}else if(t<this.chaseTime+this.explodeTime){t-=this.chaseTime;let o;t>this.explodeTime/2?(o=2-2*t/this.explodeTime,this.enemyScale=this.maxEnemyScale*o):o=2*t/this.explodeTime,this.explosionScale=this.maxExplosionScale*o;let r=p((this.explosionScale+a.playerScale)/2,2);for(let t of e.entities)if(t instanceof O){let e=this.position.subtract(t.position),a=e.dist2();a<p((this.explosionScale+t.enemyScale)/2,2)&&(t.dying=!0)}!this.spent&&l<r&&(a.attack(0.25),this.spent=!0)}else return!1}return!0}}class O extends L{constructor(e,t,a,o){super(e,t,a,o),this.maxEnemyScale=0.13,this.prevShotTime=Date.now(),this.dying=!1,this.enemyScale=this.maxEnemyScale}draw(e){let t=e.renderer,o=t.gl;e.shooterProgram.use(),t.modelMat=a(this.position.x-this.enemyScale/2,this.position.y-this.enemyScale/2,this.enemyScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){if(this.dying){if(!this.dieStart)this.dieStart=Date.now();else{let e=(Date.now()-this.dieStart)*S.TIME_DILATION;if(this.enemyScale=i(this.enemyScale,0,e),0>=this.enemyScale)return!1}return!0}if(1e3<(Date.now()-this.prevShotTime)*S.TIME_DILATION){this.prevShotTime=Date.now();let t=e.player.position.subtract(this.position).normalize();let a=new M(this.position.x,this.position.y);a.vector=t,e.pendingEntities.push(a)}return!0}}let B=0.04;class H{constructor(e){this.game=e,this.hp=0,this.speed=S.INITIAL_PLAYER_SPEED,this.actualHP=1,this.playerScale=B,this.shield=0;let t=e.renderer;this.program=new P(t,w,"precision mediump float;uniform float g;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 b=d-.5;float c=e(distance(vec2(0,0),b)*2.,.05);vec4 a=mix(vec4(1,0,0,1),vec4(0,1,0,1),g);a.a=c,gl_FragColor=a;}"),this.shieldProgram=new P(t,w,"precision mediump float;varying vec2 d;float h(float a){return 1.-a*a;}float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 c=d-.5;float p=distance(c,vec2(0,0)),i=e(distance(vec2(0,0),c)*2.,.05),a=h((p-.8)/.5);a=a<0.?0.:a;vec4 b=mix(vec4(0,0,0,0),vec4(0,1,1,1),a);b.a=b.a<i?b.a:i,gl_FragColor=b;}")}start(e,t){this.position=new A(e+0.5,t+0.5)}attack(e){(Date.now()-this.shield)*S.TIME_DILATION<S.SHIELD_DURATION||this.game.grid.get(this.position)===this.game.start||(this.actualHP-=e,0>this.actualHP&&(this.actualHP=0))}simulate(){this.hp+=0.9*((this.actualHP-this.hp)*h.delta),0.15>this.hp&&0.15>this.actualHP&&(this.actualHP=0)}draw(){let e=this.game.renderer,t=e.gl,o=(Date.now()-this.shield)*S.TIME_DILATION;if(o<S.SHIELD_DURATION){this.shieldProgram.use();let r=400,i=o<r?o/r:S.SHIELD_DURATION-o<r?(S.SHIELD_DURATION-o)/r:1,n=2*B*i;e.modelMat=a(this.position.x-n/2,this.position.y-n/2,n),e.setMatrices(),t.drawArrays(t.TRIANGLE_STRIP,0,4)}this.program.use(),t.bindBuffer(t.ARRAY_BUFFER,e.squareBuffer),t.vertexAttribPointer(this.program.vertPos,2,t.FLOAT,!1,0,0),e.modelMat=a(this.position.x-B/2,this.position.y-B/2,B),e.setMatrices(),t.uniform1f(this.program.hp,this.hp),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}class U{constructor(e,t,a,o,r,i){this.context=e,this.parent=t,this.channel=a,this.ticksPerBeat=o,this.beatsPerMinute=r,this.beatsPerBar=i,this.oscillatorPool=[],this.gainPool=[]}playSequence(e,a){let t=this.channel[1][e],o=60/(this.ticksPerBeat*this.beatsPerMinute);if(t)for(let e of t)for(let r=0;r<e.p.length;r+=1){let n=e.p[r],s=n.t*o+a;for(let t=0;t<e.n.length;t+=1){let a=e.n[t],[o,i]=this.get(t);0==r?i.gain.setValueAtTime(n.v/100,s+0.01):i.gain.exponentialRampToValueAtTime(n.v/100||1e-5,s-0.03),r==e.p.length-1&&i.gain.exponentialRampToValueAtTime(1e-4,s);let d=r==e.p.length-1?0:l(440,a-12);o.frequency.setValueAtTime(d,s)}}}play(){for(let e=0;e<this.channel[2].length;e+=1){let t=this.channel[2][e]-1;this.playSequence(t,60*(e*this.beatsPerBar)/this.beatsPerMinute)}}get(e){if(e>=this.oscillatorPool.length){let e=this.context.createOscillator(),t=this.context.createGain();t.connect(this.parent),e.connect(t),e.frequency.setValueAtTime(0,0),e.type=this.channel[0].wave,e.start(),this.oscillatorPool.push(e),this.gainPool.push(t)}return[this.oscillatorPool[e],this.gainPool[e]]}}let k="square",V=0,q=0,G=new class{constructor(){this.camera=a(-8,-8,0.85,0);let e=document.querySelector("canvas");_=this.gl=e.getContext("webgl");let t=()=>{let t=innerWidth,a=innerHeight;e.width=t,e.height=a;let o=-10,r=10,i=10,n=-10;let s=1/(o-r),l=1/(i-n);this.projMat=new Float32Array([-2*s,0,0,0,0,-2*l,0,0,0,0,2*(1/-160),0,(o+r)*s,(n+i)*l,0,1]),_.viewport(0,0,t,a)};onresize=t,t(),_.clearColor(0,0,0,1),_.blendFunc(_.SRC_ALPHA,_.ONE_MINUS_SRC_ALPHA),_.enable(_.BLEND),this.squareBuffer=_.createBuffer(),_.bindBuffer(_.ARRAY_BUFFER,this.squareBuffer),_.bufferData(_.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),_.STATIC_DRAW)}use(e){this.currentProgram!==e&&(this.currentProgram=e,_.useProgram(e.shaderProgram))}setMatrices(){_.uniformMatrix4fv(this.currentProgram.viewMat,!1,this.camera),_.uniformMatrix4fv(this.currentProgram.modelMat,!1,this.modelMat),_.uniformMatrix4fv(this.currentProgram.projMat,!1,this.projMat)}},z=new class{constructor(e){this.renderer=e,this.downMap={},this.startTime=Date.now(),this.minimapActivated=0,this.level=0,this.maxLevel=0,this.shadowCount=0,this.startVector=[0,0],this.currentVector=[0,0],this.mazeShaders=new P(e,w,"precision mediump float;uniform int k,m,o;uniform float j,l,f;varying vec2 d;float h(float a){return 1.-a*a;}void main(){vec4 i=vec4(0,0,0,f),b=vec4(1,1,1,f);b=k==0?m==1?vec4(1,0,0,1):mod((d.x-d.y)*10.,2.)>1.?vec4(1,1,0,1):vec4(.2,.2,.2,1):k==1?m==1?vec4(0,1,0,1):mod(d.x*10.,2.)>1.&&mod(d.y*10.,2.)>1.||mod(d.x*10.,2.)<1.&&mod(d.y*10.,2.)<1.?vec4(1,1,1,1):vec4(0,0,0,1):k==2?vec4(.5,.5,.5,1):b;vec4 a=mix(vec4(.5,.5,.5,1),b,1.-h(k<2?1.:j));if(m==1&&o==1){float c=l<.5?l/.5:1.-(l-.5)/.5;a=mix(a,vec4(.5,.5,.5,1),c);}a.a=1.-f,gl_FragColor=a;}"),this.shooterProgram=new P(e,w,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.05);gl_FragColor=vec4(1,0,0,b);}"),this.bulletShaders=new P(e,w,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float c=distance(vec2(0,0),a)*2.,b=e(c,.05)*2.,i=(atan(a.y/a.x)+1.)/2.;gl_FragColor=mix(vec4(.1,.1,.1,b),vec4(.2,.3,.8,b),i);}"),this.proximityProgram=new P(e,w,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.02);gl_FragColor=vec4(.3,.3,.7,b);}"),this.explosionProgram=new P(e,w,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.02);gl_FragColor=vec4(.8,0,0,b);}"),this.shadowShaders=new P(e,w,"precision mediump float;uniform float g;void main(){gl_FragColor=mix(vec4(0,0,0,1.),vec4(1,1,1,1.),g>1.?(g-1.)*2.:0.);}"),this.flashlightShaders=new P(e,w,"precision mediump float;uniform float j,g;varying vec2 d;float h(float a){return 1.-a*a;}float r(float a){return (1.+.2*sin(5e-3*a)+.05*sin(.8*a)+.4*sin(.024*a)+.2*sin(.1*a))/10.;}void main(){vec2 b=d-.5;float a=1.-h(distance(vec2(0,0),b/(.55*g)));a+=r(j),gl_FragColor=mix(vec4(0,0,0,a),vec4(1,1,1,1),g>1.?(g-1.)*2.:0.);}"),this.indicatorShaders=new P(e,w,"precision mediump float;uniform float j;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.05);gl_FragColor=vec4(0,.75,.75,b*.85*j);}"),this.dropShadowShaders=new P(e,w,"precision mediump float;uniform float f;void main(){gl_FragColor=vec4(0,0,0,1.-f);}"),this.shieldProgram=new P(e,w,"precision mediump float;uniform float f;varying vec2 d;float h(float a){return 1.-a*a;}void main(){vec2 c=d-.5;float i=distance(vec2(0,0),c)*2.1;vec2 a=d-vec2(.5,.8);a.x*=23.,a.y*=-36.;bool b=false;b=a.x>-7.&&a.x<7.&&a.y>a.x*a.x/2.5?a.y<(a.x<-3.5?pow(a.x+3.5,2.)/6.+17.5:a.x<0.?pow(a.x+3.5,2.)/1.7+17.5:a.x<3.5?pow(a.x-3.5,2.)/1.7+17.5:pow(a.x-3.5,2.)/6.+17.5):b,gl_FragColor=b?mix(vec4(0,1,1,1.-f),vec4(0,0.,0.,1.-f),1.-h(i+f)):vec4(0,0,0,0);}"),this.player=new H(this),this.buildWorld(),onkeydown=(e)=>{this.downMap[e.key.toLowerCase()]=1},onkeyup=(e)=>{this.downMap[e.key.toLowerCase()]=0};let t=(e)=>{e.preventDefault();let t=e.targetTouches&&e.targetTouches[0]||e;this.startVector=[t.clientX,t.clientY]},a=(e)=>{e.preventDefault(),this.startVector=[0,0]},o=(e)=>{e.preventDefault();let t=e.targetTouches&&e.targetTouches[0]||e;this.currentVector=[t.clientX,t.clientY]};addEventListener("touchstart",t,{passive:!1}),addEventListener("touchend",a,{passive:!1}),addEventListener("touchmove",o,{passive:!1}),onmouseup=a,onmousedown=t,onmousemove=o}buildWorld(){this.entities=[],this.pendingEntities=[],this.minimapActivated=0;let t=s(this.level);[this.grid,this.start,this.end]=I(t,t),r(this.level,this.maxLevel);let a=[C,O],o=[F,D];for(let t in this.grid.nodes){let r=this.grid.nodes[t];if(r!==this.start&&r!==this.end){if(0===e(0,10)){let t=o[e(0,o.length)];this.entities.push(new t(r.position.x,r.position.y))}let t=e(0,2);for(let o=0;o<t;o+=1){let t=a[e(0,a.length)],o=new t(r.position.x+0.2+0.6*Math.random(),r.position.y+0.2+0.6*Math.random(),this.level,r.distance);this.entities.push(o)}}}this.player.start(this.start.position.x,this.start.position.y)}processInput(){let{player:e,grid:t,downMap:a}=this;let{x:r,y:i}=e.position;let n=r,s=i,l=t.get(e.position);if(!this.startVector[0]&&!this.startVector[1])a.arrowup&&(i-=e.speed*h.delta),a.arrowdown&&(i+=e.speed*h.delta),a.arrowleft&&(r-=e.speed*h.delta),a.arrowright&&(r+=e.speed*h.delta),a.w&&(i-=e.speed*h.delta),a.s&&(i+=e.speed*h.delta),a.a&&(r-=e.speed*h.delta),a.d&&(r+=e.speed*h.delta);else{let t=[this.currentVector[0]-this.startVector[0],this.currentVector[1]-this.startVector[1]];t=t[0]*t[0]>p(S.MAX_TOUCH_DISTANCE,2)?o(t):[t[0]/S.MAX_TOUCH_DISTANCE,t[1]/S.MAX_TOUCH_DISTANCE],r+=t[0]*e.speed*h.delta,i+=t[1]*e.speed*h.delta}let d=0.01,c=d;0.5>n%1&&(d*=-1),0.5>s%1&&(c*=-1),l.passable(new A(r+d,s+c))&&(e.position.x=r),l.passable(new A(n+d,i+c))&&(e.position.y=i),l.touched=!1,l.time||(l.time=Date.now())}buildShadows(){let e=[];let t=500;for(let a in this.grid.nodes){function r(a,r,i,n){let s=o([a-l,r-d]),p=o([i-l,n-d]),c=[a+s[0]*t,r+s[1]*t],v=[i+p[0]*t,n+p[1]*t];e=e.concat([a,r],c,[i,n],c,[i,n],v)}let i=this.grid.nodes[a],{x:n,y:s}=i.position,{x:l,y:d}=this.player.position,p=l-n,c=d-s;p*p+c*c<4&&(!i.passable(new A(n,s-1))&&r(n,s,n+1,s),!i.passable(new A(n-1,s))&&r(n,s,n,s+1))}let{gl:a}=this.renderer;this.shadowBuffer&&a.deleteBuffer(this.shadowBuffer),this.shadowBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.shadowBuffer);let r=new Float32Array(e);a.bufferData(a.ARRAY_BUFFER,r,a.STREAM_DRAW),this.shadowCount=r.length/2}draw(){var e=Math.abs;h.lastFrame+=1e3*h.delta/S.TIME_DILATION,h.delta=(Date.now()-h.lastFrame)/1e3*S.TIME_DILATION,this.processInput();let t=this.player,o=S.CAMERA_SCALE;this.renderer.camera=new Float32Array([o,0,0,0,0,o,0,0,0,0,1,0,-o*t.position.x,-o*t.position.y,1,1]),this.buildShadows();let r=this.renderer.gl;this.grid.draw(this,!1);let i=[];this.entities=this.entities.concat(this.pendingEntities),this.pendingEntities=[];for(let a of this.entities){if(e(t.position.x-a.position.x)>S.RENDER_AOE||e(t.position.y-a.position.y)>S.RENDER_AOE)continue;let o=a.simulate(this);o?a.draw(this):i.push(a)}for(let e of i)this.entities.splice(this.entities.indexOf(e),1);t.simulate(),t.draw(),this.flashlightShaders.use(),this.renderer.modelMat=a(t.position.x-1,t.position.y-1,2),this.renderer.setMatrices(),r.uniform1f(this.flashlightShaders.hp,this.player.hp),r.uniform1f(this.flashlightShaders.t,(Date.now()-this.startTime)/100),r.drawArrays(r.TRIANGLE_STRIP,0,4),this.shadowCount&&(this.shadowShaders.use(),r.bindBuffer(r.ARRAY_BUFFER,this.shadowBuffer),r.vertexAttribPointer(this.mazeShaders.vertPos,2,r.FLOAT,!1,0,0),this.renderer.modelMat=a(0,0,1),this.renderer.setMatrices(),r.uniform1f(this.shadowShaders.hp,this.player.hp),r.drawArrays(r.TRIANGLES,0,this.shadowCount));let n=this.end.position.add(0.5).add(t.position);let s=0.75,l=c(p(n.x,2)+p(n.x,2));let d=0;if(l>s*s&&(n=n.normalize().multiply(s)),d=0.5>l?0:1.5<l?1:l-0.5,this.indicatorShaders.use(),r.bindBuffer(r.ARRAY_BUFFER,this.renderer.squareBuffer),r.vertexAttribPointer(this.indicatorShaders.vertPos,2,r.FLOAT,!1,0,0),this.renderer.modelMat=a(t.position.x-0.02+n.x,t.position.y-0.02+n.y,0.04),this.renderer.setMatrices(),r.uniform1f(this.indicatorShaders.t,d),r.drawArrays(r.TRIANGLE_STRIP,0,4),(Date.now()-this.minimapActivated)*S.TIME_DILATION<S.MINIMAP_DURATION){let e=2/this.grid.height;this.renderer.camera=new Float32Array([e,0,0,0,0,e,0,0,0,0,1,0,8,-10,1,1]),this.grid.draw(this,!0)}(0.01>t.hp&&1>t.actualHP||1.5<=t.hp&&1.5<t.actualHP)&&(1<t.hp?this.level+=1:this.level=0,this.level>this.maxLevel&&(this.maxLevel=this.level),t.actualHP=1,this.buildWorld());let v=this.grid.get(t.position);v===this.end&&(t.actualHP=1.8,this.entities=[])}}(G),Y=new class{constructor(e,t,a,o){this.channels=[];let r=new AudioContext,i=r.createGain();i.gain.value=0.01,i.connect(r.destination);for(let n of e){let e=new U(r,i,n,t,a,o);this.channels.push(e)}}play(){for(let e of this.channels)e.play()}}([[{wave:k,envelope:V,filter:q},[[{n:[54],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[54],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[51],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[47],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[56,55],p:[{t:24,b:0,v:100},{t:26,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[50],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[47],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[44],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[42],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[42],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[56],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[59],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[63],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[66],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[67],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[71],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[51],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[59],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[54],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[51],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[47],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[56],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[54],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[51],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[50],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[47],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[44,43],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[51],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[59],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[60],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[59],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[63],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[56],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[59],p:[{t:6,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[55],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[56],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[59],p:[{t:14,b:0,v:100},{t:16,b:0,v:100}]},{n:[56],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[55],p:[{t:18,b:0,v:100},{t:20,b:0,v:100}]},{n:[54,59],p:[{t:24,b:0,v:100},{t:26,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[56],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[59],p:[{t:6,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[55],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[54],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[51],p:[{t:14,b:0,v:100},{t:16,b:0,v:100}]},{n:[50],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[47],p:[{t:18,b:0,v:100},{t:20,b:0,v:100}]}]],[1,2,1,2,3,5,4,6,4,6,1,2,7,8,1,1]],[{wave:k,envelope:V,filter:q},[[{n:[35],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[43],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]}],[{n:[44],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[38],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]}],[{n:[38],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[31],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[38],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[35],p:[{t:28,b:0,v:100},{t:32,b:0,v:100}]}],[{n:[35],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[38],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[35],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[38],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[],[],[],[]],[1,2,1,2,1,2,3,3,3,3,1,2,4,4,1,1]],[{wave:k,envelope:V,filter:q},[[{n:[18],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[26],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[18],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[30],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[18],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[26],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[18],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[23],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[26],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[19],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[26],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[23],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[18],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[19],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[18],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[20,18],p:[{t:28,b:0,v:100},{t:32,b:0,v:100}]}],[],[],[],[]],[1,1,1,1,1,1,3,3,3,3,1,1,4,4,1,1]],[{wave:"sawtooth",envelope:V},[[],[],[],[],[],[],[],[]],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]],4,151,8);Y.play(),d()</script>