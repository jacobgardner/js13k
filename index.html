<style>body{margin:0;background:#000}canvas{height:100vmin;width:100vmin}</style><canvas></canvas><script>function a(){function a(){let a=j.innerWidth,c=j.innerHeight;b.width=a,b.height=c,n.viewport(0,0,a,c)}let b=k.querySelector('canvas');return n=b.getContext('webgl'),j.onresize=a,a(),n.clearColor(0,0,0,1),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.BLEND),n}function b(a,b){let c=n.createShader(a?n.FRAGMENT_SHADER:n.VERTEX_SHADER);return n.shaderSource(c,b),n.compileShader(c),c}function c(a,b,d=1,e=0){let f=Math.cos(e),c=h(e);return new Float32Array([f*d,c*d,0,0,-c*d,f*d,0,0,0,0,1,0,a,b,0,1])}function d(a){let[b,c]=a,d=Math.sqrt(b*b+c*c);return[b/d,c/d]}function e(a,b){let c=1e4*h(t++);return l((c-l(c))*(b-a)+a)}function f(a){return a.splice(e(0,a.length),1)[0]}function g(){let a=E.gl;a.clear(a.COLOR_BUFFER_BIT),F.draw(),j.requestAnimationFrame(g)}var h=Math.sin,i=Math.floor;let j=window,k=document,l=i,m={lastFrame:Date.now(),delta:0};let n,o,p='precision mediump float;attribute vec2 j;uniform mat4 o,k,m;varying vec2 c;void main(){gl_Position=m*k*o*vec4(j,0,1),c=j;}',q={modelMat:'o',viewMat:'k',projMat:'m',hp:'d',t:'i',squareState:'g'},r={vertPos:'j'};class s{constructor(a,...c){this.renderer=a;let d=this.shaderProgram=o.createProgram();for(let e=0;2>e;e+=1)o.attachShader(d,b(e,c[e]));for(let b in o.linkProgram(d),this.use(),q)this[b]=o.getUniformLocation(d,q[b]);for(let b in r)this[b]=o.getAttribLocation(d,r[b]),o.enableVertexAttribArray(this[b])}use(){this.renderer.use(this)}}let t=i(1e4*Math.random());let u=20,v=20,w=3;class z{constructor(a,b){this.untouched=[],this.children=[],this.touched=!1,this.distance=0,this.time=0,this.position=[a,b]}passable(a,b){if(a=i(a),b=i(b),this.position[0]===a&&this.position[1]===b)return!0;for(let c of this.children)if(c.position[0]===i(a)&&c.position[1]===i(b))return!0;return!1}draw(a){let[b,d]=this.position,e=a.renderer,f=e.gl;e.modelMat=c(b,d),e.setMatrices(),f.uniform1i(a.mazeShaders.squareState,this===a.start?0:this===a.end?1:this.touched?2:3);let g=this.time?(Date.now()-this.time)/350:0;1<g&&(g=1),f.uniform1f(a.mazeShaders.t,g),f.drawArrays(f.TRIANGLE_STRIP,0,4)}}class x{get(a,b){let c=[a,b].toString();if(a>=u||b>=v||0>a||0>b)return null;let d=this[c];return d||(d=this[c]=new z(a,b)),d}draw(a){for(let b in a.mazeShaders.use(),this){let c=this[b];c.draw(a)}}}var y=function(){let a=new x,b=[[-1,0],[1,0],[0,-1],[0,1]];for(let c=0;c<u;c++)for(let d=0;d<v;d++){let e=a.get(c,d);for(let f of b){let b=a.get(c+f[0],d+f[1]);b&&e.untouched.push(b)}}let c=a.get(e(0,u),e(0,v)),d=[c];let g=c;for(;d.length;){let a=d[0];if(a.touched=!0,!a.untouched.length){d.shift();continue}let b=f(a.untouched);b.touched||(b.untouched.splice(b.untouched.indexOf(a),1),b.children.push(a),b.distance=a.distance+1,b.distance>g.distance&&(g=b),a.children.push(b),b.touched=!0,d.splice(0,0,b))}return[a,c,g]};class A{constructor(a,b){this.x=a,this.y=b,this.bulletScale=0.4,this.bulletSpeed=0.4/this.bulletScale}draw(a){let b=a.renderer,d=b.gl;a.bulletShaders.use(),b.modelMat=c(this.x-this.bulletScale/2,this.y-this.bulletScale/2,this.bulletScale),b.setMatrices(),d.drawArrays(d.TRIANGLE_STRIP,0,4)}simulate(a){let c=this.x+this.vector[0]*this.bulletSpeed*m.delta,d=this.y+this.vector[1]*this.bulletSpeed*m.delta,b=a.grid.get(i(this.x),i(this.y)),e=a.player;if(b!==a.start&&b!==a.end&&b.passable(c,d)){let{x:f,y:g}=e;if(b.passable(f,g)){let h=c-f,a=d-g;if(h*h+a*a<0.04*0.04)return e.attack(0.06),!1}return this.x=c,this.y=d,!0}return!1}}class B{constructor(a,b){this.x=a,this.y=b,this.enemyScale=0.8,this.prevShotTime=Date.now()}draw(a){let b=a.renderer,d=b.gl;a.enemyShaders.use(),b.modelMat=c(this.x-this.enemyScale/2,this.y-this.enemyScale/2,this.enemyScale),b.setMatrices(),d.drawArrays(d.TRIANGLE_STRIP,0,4)}simulate(a){if(1e3<Date.now()-this.prevShotTime){this.prevShotTime=Date.now();let b=d([a.player.x-this.x,a.player.y-this.y]);let c=new A(this.x,this.y);c.vector=b,a.pendingEntities.push(c)}return!0}}let C=0.4;class D{constructor(a){this.renderer=a,this.hp=0,this.speed=0.7/C,this.actualHP=1,this.program=new s(a,p,'precision mediump float;uniform float d;varying vec2 c;float f(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 b=c-.5;float a=f(distance(vec2(0,0),b/.1));gl_FragColor=mix(vec4(1,0,0,a),vec4(0,1,0,a),d);}')}start(a,b){[this.x,this.y]=[a+0.5,b+0.5]}attack(a){this.actualHP-=a,0>this.actualHP&&(this.actualHP=0)}simulate(){this.hp+=0.9*((this.actualHP-this.hp)*m.delta),0.15>this.hp&&0.15>this.actualHP&&(this.actualHP=0)}draw(){this.program.use();let a=this.renderer.gl;a.bindBuffer(a.ARRAY_BUFFER,this.renderer.squareBuffer),a.vertexAttribPointer(this.program.vertPos,2,a.FLOAT,!1,0,0),this.renderer.modelMat=c(this.x-C/2,this.y-C/2,C),this.renderer.setMatrices(),a.uniform1f(this.program.hp,this.hp),a.drawArrays(a.TRIANGLE_STRIP,0,4)}}k.title='Lst';let E=new class{constructor(){this.camera=c(-8,-8,0.85,0),this.gl=o=a(),this.squareBuffer=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.squareBuffer),o.bufferData(o.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),o.STATIC_DRAW)}use(a){this.currentProgram!==a&&(this.currentProgram=a,o.useProgram(a.shaderProgram))}setMatrices(){let a=-10,b=10,c=10,d=-10,e=1/(a-b),f=1/(c-d);o.uniformMatrix4fv(this.currentProgram.viewMat,!1,this.camera),o.uniformMatrix4fv(this.currentProgram.modelMat,!1,this.modelMat),o.uniformMatrix4fv(this.currentProgram.projMat,!1,new Float32Array([-2*e,0,0,0,0,-2*f,0,0,0,0,2*(1/-160),0,(a+b)*e,(d+c)*f,0,1]))}},F=new class{constructor(a){this.renderer=a,this.downMap={},this.startTime=Date.now(),this.shadowCount=0,this.mazeShaders=new s(a,p,'precision mediump float;uniform int g;uniform float i;varying vec2 c;float h(float a){return 1.-a*a;}void main(){vec4 e=vec4(0,0,0,1),a=vec4(1,1,1,1);a=g==0?mod((c.x-c.y)*10.,2.)>1.?vec4(1,1,0,1):vec4(.2,.2,.2,1):g==1?mod(c.x*10.,2.)>1.&&mod(c.y*10.,2.)>1.||mod(c.x*10.,2.)<1.&&mod(c.y*10.,2.)<1.?vec4(1,1,1,1):vec4(0,0,0,1):g==2?vec4(.5,.5,.5,1):a;vec4 b=mix(vec4(.5,.5,.5,1),a,1.-h(g<2?1.:i));gl_FragColor=b;}'),this.enemyShaders=new s(a,p,'precision mediump float;varying vec2 c;float f(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 a=c-.5;float b=f(distance(vec2(0,0),a/.1));gl_FragColor=vec4(1,0,0,b);}'),this.bulletShaders=new s(a,p,'precision mediump float;varying vec2 c;float f(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 a=c-.5;float e=distance(vec2(0,0),a/.1),b=f(e),n=(atan(a.y/a.x)+1.)/2.;gl_FragColor=mix(vec4(.1,.1,.1,b),vec4(.2,.3,.8,b),n);}'),this.shadowShaders=new s(a,p,'precision mediump float;uniform float d;void main(){gl_FragColor=mix(vec4(0,0,0,1),vec4(1,1,1,1),d>1.?(d-1.)*2.:0.);}'),this.flashlightShaders=new s(a,p,'precision mediump float;uniform float i,d;varying vec2 c;float h(float a){return 1.-a*a;}float l(float a){return (1.+.2*sin(5e-3*a)+.05*sin(.8*a)+.4*sin(.024*a)+.2*sin(.1*a))/10.;}void main(){vec2 b=c-.5;float a=1.-h(distance(vec2(0,0),b/(.55*d)));a+=l(i),gl_FragColor=mix(vec4(0,0,0,a),vec4(1,1,1,1),d>1.?(d-1.)*2.:0.);}'),this.player=new D(a),this.buildWorld(),onkeydown=(a)=>{this.downMap[a.key.toLowerCase()]=1},onkeyup=(a)=>{this.downMap[a.key.toLowerCase()]=0}}buildWorld(){for(let a in this.entities=[],this.pendingEntities=[],[this.grid,this.start,this.end]=y(),this.grid){let b=this.grid[a];if(b!==this.start&&b!==this.end){let a=e(0,2);for(let c=0;c<a;c+=1){let a=new B(b.position[0]+0.2+0.6*Math.random(),b.position[1]+0.2+0.6*Math.random());this.entities.push(a)}}}this.player.start(this.start.position[0],this.start.position[1])}processInput(){var a=Math.round;let{player:b,grid:c,downMap:d}=this;let[e,f]=[b.x,b.y];let g=b.x,h=b.y,j=c.get(i(g),i(h));d.arrowup&&(f-=b.speed*m.delta),d.arrowdown&&(f+=b.speed*m.delta),d.arrowleft&&(e-=b.speed*m.delta),d.arrowright&&(e+=b.speed*m.delta),d.w&&(f-=b.speed*m.delta),d.s&&(f+=b.speed*m.delta),d.a&&(e-=b.speed*m.delta),d.d&&(e+=b.speed*m.delta),e=a(100*e)/100,f=a(100*f)/100;let k=0.01,l=k;0.5>g%1&&(k*=-1),0.5>h%1&&(l*=-1),j.passable(e+k,h+l)&&(b.x=e),j.passable(g+k,f+l)&&(b.y=f),j.touched=!1,j.time||(j.time=Date.now())}buildShadows(){let a=[];let b=500;for(let c in this.grid){function e(c,e,f,g){let h=d([c-i,e-j]),k=d([f-i,g-j]),l=[c+h[0]*b,e+h[1]*b],m=[f+k[0]*b,g+k[1]*b];a=a.concat([c,e],l,[f,g],l,[f,g],m)}let f=this.grid[c],[g,h]=f.position,[i,j]=[this.player.x,this.player.y],k=i-g,l=j-h;k*k+l*l<4&&(!f.passable(g,h-1)&&e(g,h,g+1,h),!f.passable(g-1,h)&&e(g,h,g,h+1))}let{gl:c}=this.renderer;this.shadowBuffer&&c.deleteBuffer(this.shadowBuffer),this.shadowBuffer=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,this.shadowBuffer);let e=new Float32Array(a);c.bufferData(c.ARRAY_BUFFER,e,c.STREAM_DRAW),this.shadowCount=e.length/2}draw(){var a=Math.abs;m.lastFrame+=1e3*m.delta,m.delta=(Date.now()-m.lastFrame)/1e3,this.processInput();let b=12,d=this.player;this.renderer.camera=new Float32Array([b,0,0,0,0,b,0,0,0,0,1,0,-b*d.x,-b*d.y,1,1]),this.buildShadows();let e=this.renderer.gl;e.bindBuffer(e.ARRAY_BUFFER,this.renderer.squareBuffer),e.vertexAttribPointer(this.mazeShaders.vertPos,2,e.FLOAT,!1,0,0),this.grid.draw(this);let f=[];this.entities=this.entities.concat(this.pendingEntities),this.pendingEntities=[];for(let b of this.entities){if(a(d.x-b.x)>w||a(d.y-b.y)>w)continue;let c=b.simulate(this);c?b.draw(this):f.push(b)}for(let a of f)this.entities.splice(this.entities.indexOf(a),1);d.simulate(),d.draw(),this.flashlightShaders.use(),this.renderer.modelMat=c(this.player.x-1,this.player.y-1,2),this.renderer.setMatrices(),e.uniform1f(this.flashlightShaders.hp,this.player.hp),e.uniform1f(this.flashlightShaders.t,(Date.now()-this.startTime)/100),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.shadowCount&&(this.shadowShaders.use(),e.bindBuffer(e.ARRAY_BUFFER,this.shadowBuffer),e.vertexAttribPointer(this.mazeShaders.vertPos,2,e.FLOAT,!1,0,0),this.renderer.modelMat=c(0,0,1),this.renderer.setMatrices(),e.uniform1f(this.shadowShaders.hp,this.player.hp),e.drawArrays(e.TRIANGLES,0,this.shadowCount)),(0.01>d.hp&&1>d.actualHP||1.5<=d.hp&&1.5<d.actualHP)&&(d.actualHP=1,this.buildWorld());let g=this.grid.get(i(d.x),i(d.y));g===this.end&&(d.actualHP=1.8,this.entities=[])}}(E);g()</script>