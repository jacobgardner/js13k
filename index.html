<style>body{margin:0;background:#000}canvas{height:100vmin;width:100vmin}</style><canvas></canvas><script>function a(){function a(){let a=i.innerWidth,c=i.innerHeight;b.width=a,b.height=c,m.viewport(0,0,a,c)}let b=j.querySelector('canvas');return m=b.getContext('webgl'),i.onresize=a,a(),m.clearColor(0,0,0,1),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA),m.enable(m.BLEND),m}function b(a,b){let c=m.createShader(a?m.FRAGMENT_SHADER:m.VERTEX_SHADER);return m.shaderSource(c,b),m.compileShader(c),c}function c(a,b,d=1,e=0){let f=Math.cos(e),c=g(e);return new Float32Array([f*d,c*d,0,0,-c*d,f*d,0,0,0,0,1,0,a,b,0,1])}function d(a,b){let c=1e4*g(s++);return k((c-k(c))*(b-a)+a)}function e(a){return a.splice(d(0,a.length),1)[0]}function f(){let a=H.gl;a.clear(a.COLOR_BUFFER_BIT),I.draw(),i.requestAnimationFrame(f)}var g=Math.sin,h=Math.floor;let i=window,j=document,k=h,l={lastFrame:Date.now(),delta:0};let m,n,o='precision mediump float;attribute vec2 i;uniform mat4 m,j,k;varying vec2 c;void main(){gl_Position=k*j*m*vec4(i,0,1),c=i;}',p={modelMat:'m',viewMat:'j',projMat:'k',t:'h',squareType:'g',squareState:'f'},q={vertPos:'i'};class r{constructor(a,...c){this.renderer=a;let d=this.shaderProgram=n.createProgram();for(let e=0;2>e;e+=1)n.attachShader(d,b(e,c[e]));for(let b in n.linkProgram(d),this.use(),p)this[b]=n.getUniformLocation(d,p[b]);for(let b in q)this[b]=n.getAttribLocation(d,q[b]),n.enableVertexAttribArray(this[b])}use(){this.renderer.use(this)}}let s=h(1e4*Math.random());let t=20,u=20,v=1,w=1,z=2,A=4,B=8;class C{constructor(a,b){this.untouched=[],this.children=[],this.touched=!1,this.distance=0,this.time=0,this.position=[a,b]}classify(){let a=0;for(let b of this.children){let c=this.position[0]-b.position[0],d=this.position[1]-b.position[1];a+=1==c?w:-1==c?z:1==d?A:B}return a}passable(a,b){if(a=h(a),b=h(b),this.position[0]===a&&this.position[1]===b)return!0;for(let c of this.children)if(c.position[0]===h(a)&&c.position[1]===h(b))return!0;return!1}draw(a){let[b,d]=this.position,e=a.renderer,f=e.gl;e.modelMat=c(b,d),e.setMatrices();let g=this.classify();f.uniform1i(a.mazeShaders.squareState,this===a.start?0:this===a.end?1:this.touched?2:3);let h=this.time?(Date.now()-this.time)/350:0;1<h&&(h=1),f.uniform1f(a.mazeShaders.t,h),f.uniform4iv(a.mazeShaders.squareType,[w&g,A&g,z&g,B&g]),f.drawArrays(f.TRIANGLE_STRIP,0,4)}}class x{get(a,b){let c=[a,b].toString();if(a>=t||b>=u||0>a||0>b)return null;let d=this[c];return d||(d=this[c]=new C(a,b)),d}draw(a){for(let b in a.mazeShaders.use(),this){let c=this[b];c.draw(a)}}}var y=function(){let a=new x,b=[[-1,0],[1,0],[0,-1],[0,1]];for(let c=0;c<t;c++)for(let d=0;d<u;d++){let e=a.get(c,d);for(let f of b){let b=a.get(c+f[0],d+f[1]);b&&e.untouched.push(b)}}let c=a.get(d(0,t),d(0,u)),f=[c];let g=c;for(;f.length;){let a=f[0];if(a.touched=!0,!a.untouched.length){f.shift();continue}let b=e(a.untouched);b.touched||(b.untouched.splice(b.untouched.indexOf(a),1),b.children.push(a),b.distance=a.distance+1,b.distance>g.distance&&(g=b),a.children.push(b),b.touched=!0,f.splice(0,0,b))}return[a,c,g]};class D{constructor(a,b){this.x=a,this.y=b,this.bulletScale=0.4,this.bulletSpeed=0.4/this.bulletScale}draw(a){let b=a.renderer,d=b.gl;a.bulletShaders.use(),b.modelMat=c(this.x-this.bulletScale/2,this.y-this.bulletScale/2,this.bulletScale),b.setMatrices(),d.drawArrays(d.TRIANGLE_STRIP,0,4)}simulate(a){let c=this.x+this.vector[0]*this.bulletSpeed*l.delta,d=this.y+this.vector[1]*this.bulletSpeed*l.delta,b=a.grid.get(h(this.x),h(this.y)),e=a.player;if(b.passable(c,d)){let f=c-e.x,a=d-e.y;return f*f+a*a<0.04*0.04?(e.hp-=0.15,!1):(this.x=c,this.y=d,!0)}return!1}}class E{constructor(a,b){this.x=a,this.y=b,this.enemyScale=0.8,this.prevShotTime=Date.now()}draw(a){let b=a.renderer,d=b.gl;a.enemyShaders.use(),b.modelMat=c(this.x-this.enemyScale/2,this.y-this.enemyScale/2,this.enemyScale),b.setMatrices(),d.drawArrays(d.TRIANGLE_STRIP,0,4)}simulate(a){if(1e3<Date.now()-this.prevShotTime){this.prevShotTime=Date.now();let[b,c]=[a.player.x-this.x,a.player.y-this.y];let d=Math.sqrt(b*b+c*c),e=new D(this.x,this.y);e.vector=[b/d,c/d],a.pendingEntities.push(e)}return!0}}let F=0.4;class G{constructor(a,b){this.renderer=a,this.maze=b,this.hp=1,this.speed=0.7/F,[this.x,this.y]=[b.start.position[0]+0.501,b.start.position[1]+0.501],this.program=new r(a,o,'precision mediump float;uniform float h;varying vec2 c;float e(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 b=c-.5;float a=e(distance(vec2(0,0),b/.1));gl_FragColor=mix(vec4(1,0,0,a),vec4(0,1,0,a),h);}')}draw(){this.program.use();let a=this.renderer.gl;a.bindBuffer(a.ARRAY_BUFFER,this.renderer.squareBuffer),a.vertexAttribPointer(this.program.vertPos,2,a.FLOAT,!1,0,0),this.renderer.modelMat=c(this.x-F/2,this.y-F/2,F),this.renderer.setMatrices(),a.uniform1f(this.program.t,this.hp),a.drawArrays(a.TRIANGLE_STRIP,0,4)}}j.title='Lst';let H=new class{constructor(){this.camera=c(-8,-8,0.85,0),this.gl=n=a(),this.squareBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.squareBuffer),n.bufferData(n.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),n.STATIC_DRAW)}use(a){this.currentProgram!==a&&(this.currentProgram=a,n.useProgram(a.shaderProgram))}setMatrices(){let a=-10,b=10,c=10,d=-10,e=1/(a-b),f=1/(c-d);n.uniformMatrix4fv(this.currentProgram.viewMat,!1,this.camera),n.uniformMatrix4fv(this.currentProgram.modelMat,!1,this.modelMat),n.uniformMatrix4fv(this.currentProgram.projMat,!1,new Float32Array([-2*e,0,0,0,0,-2*f,0,0,0,0,2*(1/-160),0,(a+b)*e,(d+c)*f,0,1]))}},I=new class{constructor(a){for(let b in this.renderer=a,this.entities=[],this.pendingEntities=[],this.downMap={},[this.grid,this.start,this.end]=y(),this.mazeShaders=new r(a,o,'precision mediump float;uniform ivec4 g;uniform int f;uniform float h;varying vec2 c;float l(float a){return 1.-a*a;}void main(){vec4 b=vec4(0,0,0,1),d=vec4(1,1,1,1);d=f==0?vec4(0,.5,0,1):f==1?mod(c.x*10.,2.)>1.&&mod(c.y*10.,2.)>1.||mod(c.x*10.,2.)<1.&&mod(c.y*10.,2.)<1.?vec4(1,1,1,1):vec4(0,0,0,1):f==2?vec4(.5,.5,.5,1):d;vec4 a=mix(vec4(.5,.5,.5,1),d,1.-l(f<2?1.:h));a=g.x==0&&c.x<.01?b:a,a=g.z==0&&c.x>.99?b:a,a=g.y==0&&c.y<.01?b:a,a=g.w==0&&c.y>.99?b:a,gl_FragColor=a;}'),this.enemyShaders=new r(a,o,'precision mediump float;varying vec2 c;float e(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 a=c-.5;float b=e(distance(vec2(0,0),a/.1));gl_FragColor=vec4(1,0,0,b);}'),this.bulletShaders=new r(a,o,'precision mediump float;varying vec2 c;float e(float a){float b=a<.45?1.:a>.55?0.:1.-(a-.45)/.1;return b*b;}void main(){vec2 a=c-.5;float b=e(distance(vec2(0,0),a/.1));gl_FragColor=vec4(0,0,0,b);}'),this.grid){let a=this.grid[b];if(a!==this.start&&a!==this.end){let b=d(0,3);for(let c=0;c<b;c+=1){let b=new E(a.position[0]+0.2+0.6*Math.random(),a.position[1]+0.2+0.6*Math.random());this.entities.push(b)}}}console.log(this.entities),onkeydown=(a)=>{this.downMap[a.key.toLowerCase()]=1},onkeyup=(a)=>{this.downMap[a.key.toLowerCase()]=0},this.player=new G(a,this)}processInput(){let{player:a,grid:b,downMap:c}=this;let[d,e]=[a.x,a.y];let f=a.x,g=a.y,i=b.get(h(f),h(g));c.arrowup&&(e-=a.speed*l.delta),c.arrowdown&&(e+=a.speed*l.delta),c.arrowleft&&(d-=a.speed*l.delta),c.arrowright&&(d+=a.speed*l.delta),c.w&&(e-=a.speed*l.delta),c.s&&(e+=a.speed*l.delta),c.a&&(d-=a.speed*l.delta),c.d&&(d+=a.speed*l.delta),(h(d)===h(f)||i.passable(d,g))&&(a.x=d),(h(e)===h(g)||i.passable(f,e))&&(a.y=e),i.touched=!1,i.time||(i.time=Date.now())}draw(){var a=Math.abs;l.lastFrame+=1e3*l.delta,l.delta=(Date.now()-l.lastFrame)/1e3,this.processInput();let b=12,c=this.player;this.renderer.camera=new Float32Array([b,0,0,0,0,b,0,0,0,0,1,0,-b*c.x,-b*c.y,1,1]);let d=this.renderer.gl;d.bindBuffer(d.ARRAY_BUFFER,this.renderer.squareBuffer),d.vertexAttribPointer(this.mazeShaders.vertPos,2,d.FLOAT,!1,0,0),this.grid.draw(this);let e=[];this.entities=this.entities.concat(this.pendingEntities),this.pendingEntities=[];for(let b of this.entities){if(a(c.x-b.x)>v||a(c.y-b.y)>v)continue;let d=b.simulate(this);d?b.draw(this):e.push(b)}for(let a of e)this.entities.splice(this.entities.indexOf(a),1);c.draw()}}(H);f()</script>