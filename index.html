<meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{margin:0;background:#000}b{display:flex;justify-content:center;align-items:center}canvas{height:100vmin;width:100vmin}</style><b><canvas></canvas></b><script>function e(e,t){let a=1e4*m(y++);return g((a-g(a))*(t-e)+e)}function t(t){return t.splice(e(0,t.length),1)[0]}function a(e,t,a=1,o=0){let i=b(o),n=m(o);return new Float32Array([i*a,n*a,0,0,-n*a,i*a,0,0,0,0,1,0,e,t,0,1])}function o(e){let[t,a]=e,o=v(t*t+a*a);return[t/o,a/o]}function i(e,t){document.title=`Current: ${e}, Max: ${t}`}function n(e,t,a){let o=e.createShader(t?e.FRAGMENT_SHADER:e.VERTEX_SHADER);return e.shaderSource(o,a),e.compileShader(o),o}function r(e,a,o){return e+o*(a-e)}function l(e){return u(4*Math.log2(e+1)+2)}function s(e,t){return e*c(2,(t-49)/12)}function d(){let e=G.gl;e.clear(e.COLOR_BUFFER_BIT),Y.draw(),f.requestAnimationFrame(d)}var p=Math.abs,c=Math.pow,v=Math.sqrt,b=Math.cos,m=Math.sin,u=Math.floor;let f=window,g=u,h={lastFrame:Date.now(),delta:0};let y=u(1e4*Math.random());var S={INITIAL_PLAYER_SPEED:1.2,TRANSITION:350,RENDER_AOE:4,MAX_TOUCH_DISTANCE:150,TIME_DILATION:1,CAMERA_SCALE:12,MINIMAP_DURATION:15000,SHIELD_DURATION:1e4};class T{constructor(e=0,t=0){this.x=e,this.y=t}clone(){return new T(this.x,this.y)}subtract(e){return e instanceof T?new T(this.x-e.x,this.y-e.y):new T(this.x-e,this.y-e)}add(e){return e instanceof T?new T(this.x+e.x,this.y+e.y):new T(this.x+e,this.y+e)}multiply(e){return e instanceof T?new T(this.x*e.x,this.y*e.y):new T(this.x*e,this.y*e)}dist2(e){let t=e?this.subtract(e):this;return t.x*t.x+t.y*t.y}dist(e){return v(this.dist2(e))}normalize(){let e=this.dist();return new T(this.x/e,this.y/e)}}class x{constructor(e,t){this.untouched=[],this.children=[],this.touched=!1,this.distance=0,this.time=0,this.position=new T(e,t)}passable(e,t=0){if(e=e.clone(),0.5>e.x%1?e.x-=t:e.x+=t,0.5>e.y%1?e.y-=t:e.y+=t,e.x=u(e.x),e.y=u(e.y),this.position.x===e.x&&this.position.y===e.y)return!0;for(let a of this.children)if(a.position.x===u(e.x)&&a.position.y===u(e.y))return!0;return!1}draw(e){let{x:o,y:i}=this.position,n=e.renderer,r=n.gl;n.modelMat=a(o,i),n.setMatrices();let l=u(e.player.position.x)===o&&u(e.player.position.y)===i;r.uniform1i(e.mazeShaders.playerSpace,l?1:0),r.uniform1i(e.mazeShaders.squareState,this===e.start?0:this===e.end?1:this.touched?2:3);let s=this.time?(Date.now()-this.time)/S.TRANSITION:0;1<s&&(s=1),r.uniform1f(e.mazeShaders.t,s);let t=Date.now()/1e3%1;r.uniform1f(e.mazeShaders.pulse,t),r.drawArrays(r.TRIANGLE_STRIP,0,4)}}class A{constructor(e,t){this.width=e,this.height=t,this.nodes={}}get(e){e=e.clone(),e.x=u(e.x),e.y=u(e.y);let t=[e.x,e.y].toString();if(e.x>=this.width||e.y>=this.height||0>e.x||0>e.y)return null;let a=this.nodes[t];return a||(a=this.nodes[t]=new x(e.x,e.y)),a}draw(e,t){e.mazeShaders.use();let a=e.renderer,o=a.gl;for(let i in o.bindBuffer(o.ARRAY_BUFFER,a.squareBuffer),o.vertexAttribPointer(e.mazeShaders.vertPos,2,o.FLOAT,!1,0,0),o.uniform1i(e.mazeShaders.isMinimap,t?1:0),this.nodes){let t=this.nodes[i];t.draw(e)}}}let w=[new T(-1,0),new T(1,0),new T(0,-1),new T(0,1)];var I=function(a,o){let i=new A(a,o);for(let e=0;e<a;e++)for(let t=0;t<o;t++){let a=new T(e,t),o=i.get(a);for(let e of w){let t=i.get(a.add(e));t&&o.untouched.push(t)}}let n=i.get(new T(e(0,a),e(0,o))),r=[n];let l=n;for(;r.length;){let e=r[0];if(e.touched=!0,!e.untouched.length){r.shift();continue}let a=t(e.untouched);a.touched||(a.untouched.splice(a.untouched.indexOf(e),1),a.children.push(e),a.distance=e.distance+1,a.distance>l.distance&&(l=a),e.children.push(a),a.touched=!0,r.splice(0,0,a))}return[i,n,l]};let P="precision mediump float;attribute vec2 n;uniform mat4 q,s,t;varying vec2 d;void main(){gl_Position=t*s*q*vec4(n,0,1),d=n;}",E={fade:"f",modelMat:"q",viewMat:"s",projMat:"t",hp:"g",t:"j",squareState:"k",isMinimap:"m",playerSpace:"o",pulse:"l"},R={vertPos:"n"};let _;class M{constructor(e,...t){this.renderer=e;let a=this.shaderProgram=_.createProgram();for(let o=0;2>o;o+=1)_.attachShader(a,n(_,o,t[o]));for(let o in _.linkProgram(a),this.use(),E)this[o]=_.getUniformLocation(a,E[o]);for(let o in R)this[o]=_.getAttribLocation(a,R[o]),_.enableVertexAttribArray(this[o])}use(){this.renderer.use(this)}}class L{constructor(e,t){this.bulletScale=0.05,this.bulletSpeed=0.6,this.position=new T(e,t)}draw(e){let t=e.renderer,o=t.gl;e.bulletShaders.use(),t.modelMat=a(this.position.x-this.bulletScale/2,this.position.y-this.bulletScale/2,this.bulletScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let t=this.position.add(this.vector.multiply(this.bulletSpeed*h.delta)),a=e.grid.get(this.position),o=e.grid.get(t),i=e.player;if(o&&o!==e.start&&o!==e.end&&a.passable(t,this.bulletScale/2)){let{x:o,y:n}=i.position;return a.passable(i.position)&&e.grid.get(i.position)!==e.start&&t.dist(i.position)<(i.playerScale+this.bulletScale)/2?(i.attack(0.06),!1):(this.position=t,!0)}return!1}}class N{constructor(e,t,a,o){this.level=a,this.distance=o,this.position=new T(e,t)}}class D{constructor(e,t){this.position=new T(e,t)}}class C extends D{constructor(e,t){super(e+0.5,t+0.5),this.shieldScale=0.5,this.fade=0}draw(e){let t=e.renderer,o=t.gl;e.shieldProgram.use(),o.uniform1f(e.shieldProgram.fade,this.fade),t.modelMat=a(this.position.x-this.shieldScale/2,this.position.y-this.shieldScale/2,this.shieldScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let{player:t}=e;if(!this.grabbed)0.05>t.position.dist2(this.position)&&(this.grabbed=Date.now(),e.player.shield=Date.now());else if(this.fade=(Date.now()-this.grabbed)*S.TIME_DILATION/300,1<this.fade)return!1;return!0}}class F extends D{constructor(e,t){super(e+0.5,t+0.5),this.fade=0}draw(e){var t=Math.PI;let o=1/e.grid.height,i=e.renderer,n=i.gl,r=Date.now(),l=b(2*(r/1e3%t)),d=m(2*(r/1e3%t)),s=e.renderer.camera,p=S.CAMERA_SCALE,c=l*o,v=d*o,u=this.position.subtract(e.player.position);i.camera=new Float32Array([c,v,0,0,-v,c,0,0,0,0,1,0,p*(u.x-0.1*(c+v)),p*(u.y-0.2*(c-v)),1,1]),e.dropShadowShaders.use(),n.uniform1f(e.dropShadowShaders.fade,this.fade),i.modelMat=a(-0.1/o,-0.1/o,1.2*e.grid.height),i.setMatrices(),n.drawArrays(n.TRIANGLE_STRIP,0,4),e.mazeShaders.use(),n.uniform1f(e.mazeShaders.fade,this.fade),e.grid.draw(e,!0),n.uniform1f(e.mazeShaders.fade,0),e.renderer.camera=s}simulate(e){let{player:t}=e;if(!this.grabbed)0.05>t.position.dist2(this.position)&&(this.grabbed=Date.now(),e.minimapActivated=Date.now());else if(this.fade=(Date.now()-this.grabbed)*S.TIME_DILATION/300,1<this.fade)return!1;return!0}}class O extends N{constructor(e,t,a,o){super(e,t,a,o),this.maxEnemyScale=0.2,this.maxExplosionScale=0.7,this.explosionScale=0,this.currentSpeed=0,this.chaseTime=2500,this.accelTime=600,this.explodeTime=500,this.spent=!1,this.enemyScale=this.maxEnemyScale,this.maxSpeed=0.8*S.INITIAL_PLAYER_SPEED}draw(e){let t=e.renderer,o=t.gl;e.proximityProgram.use(),t.modelMat=a(this.position.x-this.enemyScale/2,this.position.y-this.enemyScale/2,this.enemyScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4),e.explosionProgram.use(),t.modelMat=a(this.position.x-this.explosionScale/2,this.position.y-this.explosionScale/2,this.explosionScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){let t=e.grid.get(this.position),a=e.player,{x:o,y:i}=a.position,n=a.position.subtract(this.position),l=n.normalize(),s=n.dist2(),d=t.passable(a.position);if(!this.startTime&&0.5>s&&d)this.startTime=Date.now();else if(this.startTime){let t=(Date.now()-this.startTime)*S.TIME_DILATION;if(t<this.chaseTime){if(1e-3<s&&d){let e=(Date.now()-this.startTime)/this.accelTime,t=r(0,this.maxSpeed,1<e?1:e);this.position=this.position.add(l.multiply(t*h.delta))}}else if(t<this.chaseTime+this.explodeTime){t-=this.chaseTime;let o;t>this.explodeTime/2?(o=2-2*t/this.explodeTime,this.enemyScale=this.maxEnemyScale*o):o=2*t/this.explodeTime,this.explosionScale=this.maxExplosionScale*o;let i=c((this.explosionScale+a.playerScale)/2,2);for(let t of e.entities)if(t instanceof H){let e=this.position.subtract(t.position),a=e.dist2();a<c((this.explosionScale+t.enemyScale)/2,2)&&(t.dying=!0)}!this.spent&&s<i&&(a.attack(0.25),this.spent=!0)}else return!1}return!0}}class H extends N{constructor(e,t,a,o){super(e,t,a,o),this.maxEnemyScale=0.13,this.prevShotTime=Date.now(),this.dying=!1,this.enemyScale=this.maxEnemyScale}draw(e){let t=e.renderer,o=t.gl;e.shooterProgram.use(),t.modelMat=a(this.position.x-this.enemyScale/2,this.position.y-this.enemyScale/2,this.enemyScale),t.setMatrices(),o.drawArrays(o.TRIANGLE_STRIP,0,4)}simulate(e){if(this.dying){if(!this.dieStart)this.dieStart=Date.now();else{let e=(Date.now()-this.dieStart)*S.TIME_DILATION;if(this.enemyScale=r(this.enemyScale,0,e),0>=this.enemyScale)return!1}return!0}if(1e3<(Date.now()-this.prevShotTime)*S.TIME_DILATION){this.prevShotTime=Date.now();let t=e.player.position.subtract(this.position).normalize();let a=new L(this.position.x,this.position.y);a.vector=t,e.pendingEntities.push(a)}return!0}}let B=0.04;class U{constructor(e){this.game=e,this.hp=0,this.speed=S.INITIAL_PLAYER_SPEED,this.actualHP=1,this.playerScale=B,this.shield=0,this.lastHitTime=Date.now();let t=e.renderer;this.program=new M(t,P,"precision mediump float;uniform float g;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 b=d-.5;float c=e(distance(vec2(0,0),b)*2.,.05);vec4 a=mix(vec4(1,0,0,1),vec4(0,1,0,1),g);a.a=c,gl_FragColor=a;}"),this.shieldProgram=new M(t,P,"precision mediump float;varying vec2 d;float h(float a){return 1.-a*a;}float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 c=d-.5;float p=distance(c,vec2(0,0)),i=e(distance(vec2(0,0),c)*2.,.05),a=h((p-.8)/.5);a=a<0.?0.:a;vec4 b=mix(vec4(0,0,0,0),vec4(0,1,1,1),a);b.a=b.a<i?b.a:i,gl_FragColor=b;}")}start(e,t){this.position=new T(e+0.5,t+0.5)}setHP(e){this.lastHitTime=Date.now(),this.actualHP=e}attack(e){(Date.now()-this.shield)*S.TIME_DILATION<S.SHIELD_DURATION||this.game.grid.get(this.position)===this.game.start||(console.log(this.hp-this.actualHP),0.01>p(this.hp-this.actualHP)&&(console.log("LHT"),this.lastHitTime=Date.now()),this.actualHP-=e,0>this.actualHP&&(this.actualHP=0))}circularIn(e){return e*e}simulate(){let e=this.circularIn((Date.now()-this.lastHitTime)/800);this.hp=r(this.hp,this.actualHP,1<e?1:0>e?0:e),0.15>this.hp&&0.15>this.actualHP&&(this.actualHP=0)}draw(){let e=this.game.renderer,t=e.gl,o=(Date.now()-this.shield)*S.TIME_DILATION;if(o<S.SHIELD_DURATION){this.shieldProgram.use();let i=400,n=o<i?o/i:S.SHIELD_DURATION-o<i?(S.SHIELD_DURATION-o)/i:1,r=2*B*n;e.modelMat=a(this.position.x-r/2,this.position.y-r/2,r),e.setMatrices(),t.drawArrays(t.TRIANGLE_STRIP,0,4)}this.program.use(),t.bindBuffer(t.ARRAY_BUFFER,e.squareBuffer),t.vertexAttribPointer(this.program.vertPos,2,t.FLOAT,!1,0,0),e.modelMat=a(this.position.x-B/2,this.position.y-B/2,B),e.setMatrices(),t.uniform1f(this.program.hp,this.hp),t.drawArrays(t.TRIANGLE_STRIP,0,4)}}class k{constructor(e,t,a,o,i,n,r){this.context=e,this.parent=t,this.channel=a,this.ticksPerBeat=o,this.beatsPerMinute=i,this.beatsPerBar=n,this.done=r,this.oscillatorPool=[],this.gainPool=[],this.finalTime=0}playSequence(e,a){let t=this.channel[1][e],o=60/(this.ticksPerBeat*this.beatsPerMinute);if(t)for(let e of t)for(let n=0;n<e.p.length;n+=1){let r=e.p[n],l=r.t*o+a;for(let t=0;t<e.n.length;t+=1){let a=e.n[t],[o,i]=this.get(t);0==n?i.gain.setValueAtTime(r.v/100,l+0.01):i.gain.exponentialRampToValueAtTime(r.v/100||1e-5,l-0.03),n==e.p.length-1&&i.gain.exponentialRampToValueAtTime(1e-4,l);let d=n==e.p.length-1?0:s(440,a-8);o.frequency.setValueAtTime(d,l),l>this.finalTime&&(this.finalTime=l)}}}play(e){this.finalTime=0;for(let t=0;t<this.channel[2].length;t+=1){let a=this.channel[2][t]-1;this.playSequence(a,e+60*(t*this.beatsPerBar)/this.beatsPerMinute)}setTimeout(()=>{this.done()},1e3*this.finalTime+800)}get(e){if(e>=this.oscillatorPool.length){let e=this.context.createOscillator(),t=this.context.createGain();t.connect(this.parent),e.connect(t),e.frequency.setValueAtTime(0,0),e.type=this.channel[0].wave,e.start(),console.log("new oscillator"),this.oscillatorPool.push(e),this.gainPool.push(t)}return[this.oscillatorPool[e],this.gainPool[e]]}}let V="square",q=0,z=0,G=new class{constructor(){this.camera=a(-8,-8,0.85,0);let e=document.querySelector("canvas");_=this.gl=e.getContext("webgl");let t=()=>{let t=innerWidth,a=innerHeight;e.width=t,e.height=a;let o=-10,i=10,n=10,r=-10;let l=1/(o-i),s=1/(n-r);this.projMat=new Float32Array([-2*l,0,0,0,0,-2*s,0,0,0,0,2*(1/-160),0,(o+i)*l,(r+n)*s,0,1]),_.viewport(0,0,t,a)};onresize=t,t(),_.clearColor(0,0,0,1),_.blendFunc(_.SRC_ALPHA,_.ONE_MINUS_SRC_ALPHA),_.enable(_.BLEND),this.squareBuffer=_.createBuffer(),_.bindBuffer(_.ARRAY_BUFFER,this.squareBuffer),_.bufferData(_.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),_.STATIC_DRAW)}use(e){this.currentProgram!==e&&(this.currentProgram=e,_.useProgram(e.shaderProgram))}setMatrices(){_.uniformMatrix4fv(this.currentProgram.viewMat,!1,this.camera),_.uniformMatrix4fv(this.currentProgram.modelMat,!1,this.modelMat),_.uniformMatrix4fv(this.currentProgram.projMat,!1,this.projMat)}},Y=new class{constructor(e){this.renderer=e,this.downMap={},this.startTime=Date.now(),this.minimapActivated=0,this.level=0,this.maxLevel=0,this.shadowCount=0,this.startVector=[0,0],this.currentVector=[0,0],this.mazeShaders=new M(e,P,"precision mediump float;uniform int k,m,o;uniform float j,l,f;varying vec2 d;float h(float a){return 1.-a*a;}void main(){vec4 i=vec4(0,0,0,f),b=vec4(1,1,1,f);b=k==0?m==1?vec4(1,0,0,1):mod((d.x-d.y)*10.,2.)>1.?vec4(1,1,0,1):vec4(.2,.2,.2,1):k==1?m==1?vec4(0,1,0,1):mod(d.x*10.,2.)>1.&&mod(d.y*10.,2.)>1.||mod(d.x*10.,2.)<1.&&mod(d.y*10.,2.)<1.?vec4(1,1,1,1):vec4(0,0,0,1):k==2?vec4(.5,.5,.5,1):b;vec4 a=mix(vec4(.5,.5,.5,1),b,1.-h(k<2?1.:j));if(m==1&&o==1){float c=l<.5?l/.5:1.-(l-.5)/.5;a=mix(a,vec4(.5,.5,.5,1),c);}a.a=1.-f,gl_FragColor=a;}"),this.shooterProgram=new M(e,P,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.05);gl_FragColor=vec4(1,0,0,b);}"),this.bulletShaders=new M(e,P,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float c=distance(vec2(0,0),a)*2.,b=e(c,.05)*2.,i=(atan(a.y/a.x)+1.)/2.;gl_FragColor=mix(vec4(.1,.1,.1,b),vec4(.2,.3,.8,b),i);}"),this.proximityProgram=new M(e,P,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.02);gl_FragColor=vec4(.3,.3,.7,b);}"),this.explosionProgram=new M(e,P,"precision mediump float;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.02);gl_FragColor=vec4(.8,0,0,b);}"),this.shadowShaders=new M(e,P,"precision mediump float;uniform float g;void main(){gl_FragColor=mix(vec4(0,0,0,1.),vec4(1,1,1,1.),g>1.?(g-1.)*2.:0.);}"),this.flashlightShaders=new M(e,P,"precision mediump float;uniform float j,g;varying vec2 d;float h(float a){return 1.-a*a;}float r(float a){return (1.+.2*sin(5e-3*a)+.05*sin(.8*a)+.4*sin(.024*a)+.2*sin(.1*a))/10.;}void main(){vec2 b=d-.5;float a=1.-h(distance(vec2(0,0),b/(.55*g)));a+=r(j),gl_FragColor=mix(vec4(0,0,0,a),vec4(1,1,1,1),g>1.?(g-1.)*2.:0.);}"),this.indicatorShaders=new M(e,P,"precision mediump float;uniform float j;varying vec2 d;float e(float a,float b){float c=a<1.-2.*b?1.:a>1.?0.:1.-(a-(1.-2.*b))/.1;return c*c;}void main(){vec2 a=d-.5;float b=e(distance(vec2(0,0),a)*2.,.05);gl_FragColor=vec4(0,.75,.75,b*.85*j);}"),this.dropShadowShaders=new M(e,P,"precision mediump float;uniform float f;void main(){gl_FragColor=vec4(0,0,0,1.-f);}"),this.shieldProgram=new M(e,P,"precision mediump float;uniform float f;varying vec2 d;float h(float a){return 1.-a*a;}void main(){vec2 c=d-.5;float i=distance(vec2(0,0),c)*2.1;vec2 a=d-vec2(.5,.8);a.x*=23.,a.y*=-36.;bool b=false;b=a.x>-7.&&a.x<7.&&a.y>a.x*a.x/2.5?a.y<(a.x<-3.5?pow(a.x+3.5,2.)/6.+17.5:a.x<0.?pow(a.x+3.5,2.)/1.7+17.5:a.x<3.5?pow(a.x-3.5,2.)/1.7+17.5:pow(a.x-3.5,2.)/6.+17.5):b,gl_FragColor=b?mix(vec4(0,1,1,1.-f),vec4(0,0.,0.,1.-f),1.-h(i+f)):vec4(0,0,0,0);}"),this.player=new U(this),this.buildWorld(),onkeydown=(e)=>{this.downMap[e.key.toLowerCase()]=1},onkeyup=(e)=>{this.downMap[e.key.toLowerCase()]=0};let t=(e)=>{e.preventDefault();let t=e.targetTouches&&e.targetTouches[0]||e;this.startVector=[t.clientX,t.clientY]},a=(e)=>{e.preventDefault(),this.startVector=[0,0]},o=(e)=>{e.preventDefault();let t=e.targetTouches&&e.targetTouches[0]||e;this.currentVector=[t.clientX,t.clientY]};addEventListener("touchstart",t,{passive:!1}),addEventListener("touchend",a,{passive:!1}),addEventListener("touchmove",o,{passive:!1}),onmouseup=a,onmousedown=t,onmousemove=o}buildWorld(){this.entities=[],this.pendingEntities=[],this.minimapActivated=0;let t=l(this.level);[this.grid,this.start,this.end]=I(t,t),i(this.level,this.maxLevel);let a=[O,H],o=[F,C];for(let t in this.grid.nodes){let i=this.grid.nodes[t];if(i!==this.start&&i!==this.end){if(0===e(0,40)){let t=o[e(0,o.length)];this.entities.push(new t(i.position.x,i.position.y))}let t=e(0,2);for(let o=0;o<t;o+=1){let t=a[e(0,a.length)],o=new t(i.position.x+0.2+0.6*Math.random(),i.position.y+0.2+0.6*Math.random(),this.level,i.distance);this.entities.push(o)}}}this.player.start(this.start.position.x,this.start.position.y)}processInput(){let{player:e,grid:t,downMap:a}=this;let{x:i,y:n}=e.position;let r=i,l=n,s=t.get(e.position);if(!this.startVector[0]&&!this.startVector[1])a.arrowup&&(n-=e.speed*h.delta),a.arrowdown&&(n+=e.speed*h.delta),a.arrowleft&&(i-=e.speed*h.delta),a.arrowright&&(i+=e.speed*h.delta),a.w&&(n-=e.speed*h.delta),a.s&&(n+=e.speed*h.delta),a.a&&(i-=e.speed*h.delta),a.d&&(i+=e.speed*h.delta);else{let t=[this.currentVector[0]-this.startVector[0],this.currentVector[1]-this.startVector[1]];t=t[0]*t[0]>c(S.MAX_TOUCH_DISTANCE,2)?o(t):[t[0]/S.MAX_TOUCH_DISTANCE,t[1]/S.MAX_TOUCH_DISTANCE],i+=t[0]*e.speed*h.delta,n+=t[1]*e.speed*h.delta}let d=0.01,p=d;0.5>r%1&&(d*=-1),0.5>l%1&&(p*=-1),s.passable(new T(i+d,l+p))&&(e.position.x=i),s.passable(new T(r+d,n+p))&&(e.position.y=n),s.touched=!1,s.time||(s.time=Date.now())}buildShadows(){let e=[];let t=500;for(let a in this.grid.nodes){function i(a,i,n,r){let l=o([a-s,i-d]),p=o([n-s,r-d]),c=[a+l[0]*t,i+l[1]*t],v=[n+p[0]*t,r+p[1]*t];e=e.concat([a,i],c,[n,r],c,[n,r],v)}let n=this.grid.nodes[a],{x:r,y:l}=n.position,{x:s,y:d}=this.player.position,p=s-r,c=d-l;p*p+c*c<4&&(!n.passable(new T(r,l-1))&&i(r,l,r+1,l),!n.passable(new T(r-1,l))&&i(r,l,r,l+1))}let{gl:a}=this.renderer;this.shadowBuffer&&a.deleteBuffer(this.shadowBuffer),this.shadowBuffer=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.shadowBuffer);let i=new Float32Array(e);a.bufferData(a.ARRAY_BUFFER,i,a.STREAM_DRAW),this.shadowCount=i.length/2}draw(){h.lastFrame+=1e3*h.delta/S.TIME_DILATION,h.delta=(Date.now()-h.lastFrame)/1e3*S.TIME_DILATION,this.processInput();let e=this.player,t=S.CAMERA_SCALE;this.renderer.camera=new Float32Array([t,0,0,0,0,t,0,0,0,0,1,0,-t*e.position.x,-t*e.position.y,1,1]),this.buildShadows();let o=this.renderer.gl;this.grid.draw(this,!1);let i=[];this.entities=this.entities.concat(this.pendingEntities),this.pendingEntities=[];for(let t of this.entities){if(p(e.position.x-t.position.x)>S.RENDER_AOE||p(e.position.y-t.position.y)>S.RENDER_AOE)continue;let a=t.simulate(this);a?t.draw(this):i.push(t)}for(let e of i)this.entities.splice(this.entities.indexOf(e),1);e.simulate(),e.draw(),this.flashlightShaders.use(),this.renderer.modelMat=a(e.position.x-1,e.position.y-1,2),this.renderer.setMatrices(),o.uniform1f(this.flashlightShaders.hp,this.player.hp),o.uniform1f(this.flashlightShaders.t,(Date.now()-this.startTime)/100),o.drawArrays(o.TRIANGLE_STRIP,0,4),this.shadowCount&&(this.shadowShaders.use(),o.bindBuffer(o.ARRAY_BUFFER,this.shadowBuffer),o.vertexAttribPointer(this.mazeShaders.vertPos,2,o.FLOAT,!1,0,0),this.renderer.modelMat=a(0,0,1),this.renderer.setMatrices(),o.uniform1f(this.shadowShaders.hp,this.player.hp),o.drawArrays(o.TRIANGLES,0,this.shadowCount));this.end.position.add(0.5).add(e.position);if((Date.now()-this.minimapActivated)*S.TIME_DILATION<S.MINIMAP_DURATION){let e=2/this.grid.height;this.renderer.camera=new Float32Array([e,0,0,0,0,e,0,0,0,0,1,0,8,-10,1,1]),this.grid.draw(this,!0)}(0.01>e.hp&&1>e.actualHP||1.5<=e.hp&&1.5<e.actualHP)&&(1<e.hp?this.level+=1:this.level=0,this.level>this.maxLevel&&(this.maxLevel=this.level),e.setHP(1),this.buildWorld());let n=this.grid.get(e.position);n===this.end&&1.8>e.actualHP&&(e.setHP(1.8),this.entities=[])}}(G),j=new class{constructor(e,t,a,o,i){this.beatsPerMinute=a,this.beatsPerBar=o,this.loopBars=i,this.channels=[];let n=new AudioContext;this.createdTime=Date.now();let r=n.createGain();r.gain.value=0.02,r.connect(n.destination);for(let l of e){let e=new k(n,r,l,t,a,o,()=>{this.channelsRemaining-=1,0===this.channelsRemaining&&this.play()});this.channels.push(e)}}play(){console.log("Playing..."),this.channelsRemaining=this.channels.length;let e=(Date.now()-this.createdTime)/1e3;for(let t of this.channels)t.play(e)}}([[{wave:"triangle",envelope:1,filter:z},[[{n:[54],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[54],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[51],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[47],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[56,55],p:[{t:24,b:0,v:100},{t:26,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[50],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[47],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[44],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[42],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[42],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[56],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[59],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[63],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[66],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[67],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[71],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[51],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[59],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[54],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[51],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[47],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[56],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[54],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[51],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[50],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[47],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[44,43],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]}],[{n:[54],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[51],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[59],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[60],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[59],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[63],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[56],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[59],p:[{t:6,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[55],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[56],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[59],p:[{t:14,b:0,v:100},{t:16,b:0,v:100}]},{n:[56],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[55],p:[{t:18,b:0,v:100},{t:20,b:0,v:100}]},{n:[54,59],p:[{t:24,b:0,v:100},{t:26,b:0,v:100}]}],[{n:[56],p:[{t:0,b:0,v:100},{t:2,b:0,v:100}]},{n:[55],p:[{t:2,b:0,v:100},{t:4,b:0,v:100}]},{n:[56],p:[{t:4,b:0,v:100},{t:6,b:0,v:100}]},{n:[59],p:[{t:6,b:0,v:100},{t:8,b:0,v:100}]},{n:[56],p:[{t:8,b:0,v:100},{t:10,b:0,v:100}]},{n:[55],p:[{t:10,b:0,v:100},{t:12,b:0,v:100}]},{n:[54],p:[{t:12,b:0,v:100},{t:14,b:0,v:100}]},{n:[51],p:[{t:14,b:0,v:100},{t:16,b:0,v:100}]},{n:[50],p:[{t:16,b:0,v:100},{t:18,b:0,v:100}]},{n:[47],p:[{t:18,b:0,v:100},{t:20,b:0,v:100}]}]],[1,2,1,2,3,5,4,6,4,6,1,2,7,8,1,1]],[{wave:V,envelope:q,filter:z},[[{n:[35],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[43],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]}],[{n:[44],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[38],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]}],[{n:[38],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[31],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[38],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[35],p:[{t:28,b:0,v:100},{t:32,b:0,v:100}]}],[{n:[35],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[38],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[35],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[38],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[],[],[],[]],[1,2,1,2,1,2,3,3,3,3,1,2,4,4,1,1]],[{wave:V,envelope:q,filter:z},[[{n:[18],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[26],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[18],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[30],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[18],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[26],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[18],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[23],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[26],p:[{t:0,b:0,v:100},{t:4,b:0,v:100}]},{n:[19],p:[{t:8,b:0,v:100},{t:12,b:0,v:100}]},{n:[26],p:[{t:16,b:0,v:100},{t:20,b:0,v:100}]},{n:[23],p:[{t:24,b:0,v:100},{t:28,b:0,v:100}]}],[{n:[18],p:[{t:4,b:0,v:100},{t:8,b:0,v:100}]},{n:[19],p:[{t:12,b:0,v:100},{t:16,b:0,v:100}]},{n:[18],p:[{t:20,b:0,v:100},{t:24,b:0,v:100}]},{n:[20,18],p:[{t:28,b:0,v:100},{t:32,b:0,v:100}]}],[],[],[],[]],[1,1,1,1,1,1,3,3,3,3,1,1,4,4,1,1]],[{wave:"sawtooth",envelope:q},[[],[],[],[],[],[],[],[]],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]],4,151,8,14);d()</script>